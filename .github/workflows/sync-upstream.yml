name: Sync upstream

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 09:00 UTC

permissions:
  contents: write
  pull-requests: write

env:
  UPSTREAM_REPO: https://github.com/offen/docker-volume-backup.git
  SYNC_BRANCH: chore/sync-upstream

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing sync PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          existing=$(gh pr list --head "$SYNC_BRANCH" --state open --json number --jq '.[0].number // empty')
          if [ -n "$existing" ]; then
            echo "pr_exists=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=$existing" >> "$GITHUB_OUTPUT"
          else
            echo "pr_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch upstream
        run: |
          git remote add upstream "$UPSTREAM_REPO"
          git remote set-url --push upstream https://localhost/NEVER_PUSH
          git fetch upstream main

      - name: Check for new changes
        id: diff-check
        run: |
          if git merge-base --is-ancestor upstream/main HEAD; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::notice::No new changes from upstream"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for human commits on sync branch
        if: steps.diff-check.outputs.has_changes == 'true'
        id: human-check
        run: |
          if git ls-remote --exit-code origin "refs/heads/$SYNC_BRANCH" &>/dev/null; then
            git fetch origin "$SYNC_BRANCH"
            tip_author=$(git log -1 --format='%ae' "origin/$SYNC_BRANCH")
            if [ "$tip_author" != "github-actions[bot]@users.noreply.github.com" ]; then
              echo "has_human_commits=true" >> "$GITHUB_OUTPUT"
              echo "::warning::Sync branch has human commits ($tip_author), skipping force-push"
            fi
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Attempt merge
        if: steps.diff-check.outputs.has_changes == 'true' && steps.human-check.outputs.has_human_commits != 'true'
        id: merge
        run: |
          git checkout -B "$SYNC_BRANCH"

          if git merge upstream/main \
               --allow-unrelated-histories \
               -m "chore: merge upstream docker-volume-backup changes"; then
            echo "conflict=false" >> "$GITHUB_OUTPUT"
          else
            echo "conflict=true" >> "$GITHUB_OUTPUT"
            git add -A
            git commit -m "chore: merge upstream (conflicts need resolution)"
          fi

      - name: Push sync branch
        if: steps.diff-check.outputs.has_changes == 'true' && steps.human-check.outputs.has_human_commits != 'true'
        run: git push origin "$SYNC_BRANCH" --force-with-lease

      - name: Comment on existing PR (human commits detected)
        if: steps.human-check.outputs.has_human_commits == 'true' && steps.check-pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment "${{ steps.check-pr.outputs.pr_number }}" --body \
            "New upstream changes are available but this branch has manual commits. Skipping automatic update to avoid overwriting your work. Re-run the sync workflow after merging or closing this PR."

      - name: Create or update PR
        if: steps.diff-check.outputs.has_changes == 'true' && steps.human-check.outputs.has_human_commits != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ steps.merge.outputs.conflict }}" = "true" ]; then
            body=$(cat <<'EOF'
          ## Sync from upstream

          > **Merge conflicts detected.** Conflict markers are present in the changed files.

          To resolve:
          1. Check out this branch locally: `gh pr checkout <number>`
          2. Search for conflict markers (`<<<<<<<`) and resolve them
          3. Commit and push

          **Source:** [`offen/docker-volume-backup`](https://github.com/offen/docker-volume-backup)
          EOF
          )
          else
            body=$(cat <<'EOF'
          ## Sync from upstream

          This PR merges the latest changes from upstream `offen/docker-volume-backup`.
          Review the changes before merging.

          **Source:** [`offen/docker-volume-backup`](https://github.com/offen/docker-volume-backup)
          EOF
          )
          fi

          if [ "${{ steps.check-pr.outputs.pr_exists }}" = "true" ]; then
            gh pr edit "${{ steps.check-pr.outputs.pr_number }}" --body "$body"
          else
            gh pr create \
              --head "$SYNC_BRANCH" \
              --base main \
              --title "chore: sync upstream docker-volume-backup" \
              --body "$body"
          fi
